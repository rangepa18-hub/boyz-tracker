<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Boyz Calendar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAJsOKDu8IOLVncSMryt0YQ35yM-Tg_n-k",
    authDomain: "boyz-calendar.firebaseapp.com",
    projectId: "boyz-calendar",
    storageBucket: "boyz-calendar.firebasestorage.app",
    messagingSenderId: "636214260840",
    appId: "1:636214260840:web:1bbb52bcfb97261ff9b7dd",
    measurementId: "G-YK0YWE59WX"
  };

  const app = initializeApp(firebaseConfig);
  window.db = getFirestore(app);
</script>

<style>
  /* your same CSS from before goes here (unchanged) */
</style>
</head>
<body>

<!-- your same full HTML layout from before goes here (unchanged) -->

<script type="module">
import { doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const cal=document.getElementById('calendar');
const monthPicker=document.getElementById('month');
const summary=document.getElementById('summary');
const popup=document.getElementById('popup');
const overlay=document.getElementById('overlay');

let selected = {};
let pawPositions = {};
let currentEditKey=null;
let lockTimers={};

const sharedDoc = doc(db, "shared", "calendar");

// 🔁 Live sync from Firestore
onSnapshot(sharedDoc, (snap)=>{
  if(snap.exists()){
    const data = snap.data();
    selected = data.selected || {};
    pawPositions = data.pawPositions || {};
    render(new Date(monthPicker.value.split('-')[0], monthPicker.value.split('-')[1]-1, 1));
  } else {
    render(new Date());
  }
});

async function save(){
  await setDoc(sharedDoc,{selected,pawPositions});
}

const now=new Date();
monthPicker.value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
render(new Date(now.getFullYear(), now.getMonth(), 1));

monthPicker.addEventListener('change', e=>{
  const [y,m]=e.target.value.split('-');
  render(new Date(parseInt(y,10), parseInt(m,10)-1, 1));
});

function generatePositions(){
  const bases=[{top:25,left:30},{top:25,left:70},{top:65,left:30},{top:65,left:70}];
  return bases.map(b=>({
    top: Math.max(15, Math.min(75, b.top + (Math.random()*8 - 4))),
    left: Math.max(15, Math.min(75, b.left + (Math.random()*8 - 4))),
    rot: Math.floor(Math.random()*40 - 20)
  }));
}

function render(date){
  cal.innerHTML='';
  const y=date.getFullYear(), m=date.getMonth();
  const firstDay=new Date(y,m,1).getDay();
  const daysInMonth=new Date(y,m+1,0).getDate();
  for(let i=0;i<firstDay;i++) cal.appendChild(document.createElement('div'));
  let rpCount=0, vrCount=0;

  for(let d=1;d<=daysInMonth;d++){
    const key=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cell=document.createElement('div');
    cell.className='day';

    const num=document.createElement('div');
    num.className='date-num';
    num.textContent=d;
    cell.appendChild(num);

    const entry = selected[key];
    if(entry){
      if(entry.owner==='rp') rpCount++; else if(entry.owner==='vr') vrCount++;
      if(!pawPositions[key]) pawPositions[key]=generatePositions();
      const pawClass = entry.owner==='rp' ? 'paw-blue' : 'paw-purple';
      pawPositions[key].forEach(p=>{
        const mark=document.createElement('div');
        mark.className='paw-mark ' + pawClass;
        mark.style.top=p.top+'%';
        mark.style.left=p.left+'%';
        mark.style.transform=`rotate(${p.rot}deg)`;
        cell.appendChild(mark);
      });
      if(entry.photo){
        const img=document.createElement('img');
        img.src=entry.photo;
        img.className='day-thumb';
        cell.appendChild(img);
      } else if(entry.note){
        const pin=document.createElement('div');
        pin.className='day-pin';
        pin.textContent='📌';
        cell.appendChild(pin);
      }
    }

    let pressTimer;
    cell.addEventListener('touchstart',()=>{ 
      if(entry?.locked){
        pressTimer=setTimeout(()=>{
          if(confirm('Unlock this day to edit again?')){
            selected[key].locked=false;
            save(); render(new Date(y,m,1));
          }
        },1500);
      } else {
        pressTimer=setTimeout(()=>openPopup(key),700);
      }
    });
    cell.addEventListener('touchend',()=>clearTimeout(pressTimer));
    cell.addEventListener('mousedown',()=>{ 
      if(entry?.locked){
        pressTimer=setTimeout(()=>{
          if(confirm('Unlock this day to edit again?')){
            selected[key].locked=false;
            save(); render(new Date(y,m,1));
          }
        },1500);
      } else {
        pressTimer=setTimeout(()=>openPopup(key),700);
      }
    });
    cell.addEventListener('mouseup',()=>clearTimeout(pressTimer));

    cell.addEventListener('click',()=>{
      if(entry?.locked){
        if(entry.photo){
          document.getElementById('photoFull').src = entry.photo;
          document.getElementById('photoNote').textContent = entry.note || '';
          document.getElementById('photoView').style.display='flex';
        } else if(entry.note){
          document.getElementById('noteText').textContent = entry.note;
          document.getElementById('noteView').style.display='flex';
        }
        return;
      }
      if(!selected[key]){
        selected[key]={owner:'rp',note:'',photo:null,locked:false};
        if(!pawPositions[key]) pawPositions[key]=generatePositions();
      } else if(selected[key].owner==='rp'){
        selected[key].owner='vr';
        selected[key].locked=false;
        if(!pawPositions[key]) pawPositions[key]=generatePositions();
      } else {
        delete selected[key];
        delete pawPositions[key];
      }
      clearTimeout(lockTimers[key]);
      lockTimers[key]=setTimeout(()=>{ if(selected[key]){selected[key].locked=true;save();}},5000);
      save(); render(new Date(y,m,1));
    });

    cal.appendChild(cell);
  }
  summary.textContent=`Days: ${rpCount} | Days: ${vrCount}`;
}

function openPopup(key){
  currentEditKey=key;
  const e=selected[key]||{owner:'rp',note:'',photo:null};
  document.getElementById('ownerSel').value=e.owner;
  document.getElementById('noteInput').value=e.note||'';
  document.getElementById('photoInput').value='';
  overlay.style.display='block'; popup.style.display='block';
  setTimeout(()=>document.getElementById('noteInput').focus(),300);
}
overlay.onclick=()=>{popup.style.display='none';overlay.style.display='none';};

document.getElementById('saveBtn').onclick=()=>{
  const owner=document.getElementById('ownerSel').value;
  const note=document.getElementById('noteInput').value.trim();
  const file=document.getElementById('photoInput').files[0];

  const finalize=(photoData)=>{
    selected[currentEditKey]={owner,note,photo:photoData||null,locked:false};
    clearTimeout(lockTimers[currentEditKey]);
    lockTimers[currentEditKey]=setTimeout(()=>{
      if(selected[currentEditKey]){
        selected[currentEditKey].locked=true;
        save();
      }
    },5000);
    save();
    popup.style.display='none';overlay.style.display='none';
    render(new Date(monthPicker.value.split('-')[0],monthPicker.value.split('-')[1]-1,1));
  };

  if(file){
    const reader=new FileReader();
    reader.onload=()=>finalize(reader.result); // Base64
    reader.readAsDataURL(file);
  } else {
    const existing=selected[currentEditKey]||{};
    finalize(existing.photo||null);
  }
};

document.getElementById('closePhoto').onclick = () => {
  document.getElementById('photoView').style.display='none';
};
document.getElementById('closeNote').onclick = () => {
  document.getElementById('noteView').style.display='none';
};
</script>
</body>
</html>
